---

title: Kaggle rfcx-species-audio-detection competition


keywords: fastai
sidebar: home_sidebar

summary: "This module contains the pipeline for the rfcx-species-audio-detection competition: https://www.kaggle.com/c/rfcx-species-audio-detection"
description: "This module contains the pipeline for the rfcx-species-audio-detection competition: https://www.kaggle.com/c/rfcx-species-audio-detection"
nb_path: "nbs/kaggle_rfcx-species-audio-detection.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/kaggle_rfcx-species-audio-detection.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@call_parse</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">fold</span><span class="p">:</span><span class="n">Param</span><span class="p">(</span><span class="s1">&#39;Fold number&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
         <span class="n">n_epochs</span><span class="p">:</span><span class="n">Param</span><span class="p">(</span><span class="s1">&#39;Number of training epochs&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
         <span class="n">lr</span><span class="p">:</span><span class="n">Param</span><span class="p">(</span><span class="s1">&#39;Learning rate&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
         <span class="n">wd</span><span class="p">:</span><span class="n">Param</span><span class="p">(</span><span class="s1">&#39;Weight decay&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span><span class="o">=</span><span class="mf">3e-2</span><span class="p">,</span>
         <span class="n">tile_width</span><span class="p">:</span><span class="n">Param</span><span class="p">(</span><span class="s1">&#39;Tile width&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
         <span class="n">bs</span><span class="p">:</span><span class="n">Param</span><span class="p">(</span><span class="s1">&#39;Batch size&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
         <span class="n">aug_ps</span><span class="p">:</span><span class="n">Param</span><span class="p">(</span><span class="s1">&#39;Augmentation probability&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
         <span class="n">plot</span><span class="p">:</span><span class="n">Param</span><span class="p">(</span><span class="s1">&#39;Do plot of a sample of data&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">sample_rate</span> <span class="o">=</span> <span class="mi">32000</span>
    <span class="n">num_classes</span> <span class="o">=</span> <span class="mi">24</span>
    <span class="n">seed_everything</span><span class="p">()</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/kaggle/kaggle_rainforest_audio/data&#39;</span><span class="p">)</span>
    <span class="n">rename_cols</span> <span class="o">=</span> <span class="n">RenameColumns</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;recording_id&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;species_id&#39;</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="s1">&#39;t_min&#39;</span><span class="p">,</span> 
                                <span class="n">tmax</span><span class="o">=</span><span class="s1">&#39;t_max&#39;</span><span class="p">,</span><span class="n">fmin</span><span class="o">=</span><span class="s1">&#39;f_min&#39;</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="s1">&#39;f_max&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span><span class="n">load_dataframe</span><span class="p">,</span> <span class="n">rename_cols</span><span class="p">,</span> <span class="n">group_labels</span><span class="p">])(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;train_tp.csv&#39;</span><span class="p">)</span>
    <span class="n">train_df</span><span class="p">,</span> <span class="n">valid_df</span> <span class="o">=</span> <span class="n">kfold_dataframes</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">fold</span><span class="p">)</span>

    <span class="n">tfms</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">apply_augmentations</span><span class="p">,</span> 
                   <span class="n">augs_pipeline</span><span class="o">=</span><span class="n">audio_augment</span><span class="p">(</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">aug_ps</span><span class="p">,</span> <span class="n">time_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                               <span class="n">freq_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="n">train_data</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">train_df</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">create_dataset_item</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                                               <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">tile_width</span><span class="o">=</span><span class="n">tile_width</span><span class="p">))</span>
    <span class="n">valid_data</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">valid_df</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">create_dataset_item</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                                               <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">tile_width</span><span class="o">=</span><span class="n">tile_width</span><span class="p">))</span>
    <span class="n">train_dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="n">do_batch</span><span class="o">=</span><span class="n">reorganize_batch</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                          <span class="n">after_item</span><span class="o">=</span><span class="n">tfms</span><span class="p">,</span> <span class="n">after_batch</span><span class="o">=</span><span class="n">MelSpectrogram</span><span class="p">(</span><span class="n">sample_rate</span><span class="p">))</span>
    <span class="n">valid_dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">valid_data</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="n">do_batch</span><span class="o">=</span><span class="n">reorganize_batch</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                          <span class="n">after_batch</span><span class="o">=</span><span class="n">MelSpectrogram</span><span class="p">(</span><span class="n">sample_rate</span><span class="p">))</span>
    <span class="n">dls</span> <span class="o">=</span> <span class="n">DataLoaders</span><span class="p">(</span><span class="n">train_dl</span><span class="p">,</span> <span class="n">valid_dl</span><span class="p">)</span>

    <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span> <span class="n">show_augmentations</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">train_dl</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">ResNeSt50</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span><span class="p">))</span>
    <span class="n">dls</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span><span class="p">)</span>

    <span class="n">learn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">loss_func</span><span class="o">=</span><span class="n">cross_entropy</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">lrap</span><span class="p">])</span>
    <span class="n">learn</span><span class="o">.</span><span class="n">to_fp16</span><span class="p">(</span><span class="n">clip</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span>

    <span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="n">wd</span><span class="p">,</span> <span class="n">div_final</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">div</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

