---

title: Triplet Learning


keywords: fastai
sidebar: home_sidebar

summary: "Functions for triplet learning."
description: "Functions for triplet learning."
nb_path: "nbs/00vision_triplet.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/00vision_triplet.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SampleEpisode" class="doc_header"><code>class</code> <code>SampleEpisode</code><a href="https://github.com/mnpinto/dl_pipeline/tree/master/dl_pipeline/vision/triplet.py#L11" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SampleEpisode</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwds</code></strong>) :: <code>Sampler</code></p>
</blockquote>
<p>Base class for all Samplers.</p>
<p>Every Sampler subclass has to provide an :meth:<code>__iter__</code> method, providing a
way to iterate over indices of dataset elements, and a :meth:<code>__len__</code> method
that returns the length of the returned iterators.</p>
<p>.. note:: The :meth:<code>__len__</code> method isn't strictly required by
          :class:<code>~torch.utils.data.DataLoader</code>, but is expected in any
          calculation involving the length of a :class:<code>~torch.utils.data.DataLoader</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="compute_distance_matrix" class="doc_header"><code>compute_distance_matrix</code><a href="https://github.com/mnpinto/dl_pipeline/tree/master/dl_pipeline/vision/triplet.py#L96" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>compute_distance_matrix</code>(<strong><code>dataloader</code></strong>, <strong><code>model</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="EpisodeDataLoader" class="doc_header"><code>class</code> <code>EpisodeDataLoader</code><a href="https://github.com/mnpinto/dl_pipeline/tree/master/dl_pipeline/vision/triplet.py#L115" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>EpisodeDataLoader</code>(<strong><code>fix_dl</code></strong>, <strong><code>dataset</code></strong>=<em><code>None</code></em>, <strong><code>model</code></strong>=<em><code>None</code></em>, <strong><code>n_episodes</code></strong>=<em><code>100</code></em>, <strong><code>n_way</code></strong>=<em><code>16</code></em>, <strong><code>k_shot</code></strong>=<em><code>4</code></em>, <strong>**<code>kwargs</code></strong>) :: <a href="/dl_pipeline/dataset.html#DataLoader"><code>DataLoader</code></a></p>
</blockquote>
<p>API compatible with PyTorch DataLoader, with a lot more callbacks and flexibility</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_preds" class="doc_header"><code>get_preds</code><a href="https://github.com/mnpinto/dl_pipeline/tree/master/dl_pipeline/vision/triplet.py#L141" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_preds</code>(<strong><code>dataloader</code></strong>=<em><code>None</code></em>, <strong><code>model</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="distance" class="doc_header"><code>distance</code><a href="https://github.com/mnpinto/dl_pipeline/tree/master/dl_pipeline/vision/triplet.py#L157" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>distance</code>(<strong><code>valid_preds</code></strong>, <strong><code>train_preds</code></strong>, <strong><code>train_ys</code></strong>, <strong><code>n</code></strong>=<em><code>100</code></em>)</p>
</blockquote>
<p>Compute distance of each valid sample to the train samples</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="remove_duplicates" class="doc_header"><code>remove_duplicates</code><a href="https://github.com/mnpinto/dl_pipeline/tree/master/dl_pipeline/vision/triplet.py#L168" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>remove_duplicates</code>(<strong><code>classes_preds</code></strong>, <strong><code>n</code></strong>=<em><code>5</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="map5" class="doc_header"><code>map5</code><a href="https://github.com/mnpinto/dl_pipeline/tree/master/dl_pipeline/vision/triplet.py#L178" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>map5</code>(<strong><code>final_classes</code></strong>, <strong><code>valid_y</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="accuracy" class="doc_header"><code>accuracy</code><a href="https://github.com/fastai/fastai/tree/master/fastai/metrics.py#L99" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>accuracy</code>(<strong><code>inp</code></strong>, <strong><code>targ</code></strong>, <strong><code>axis</code></strong>=<em><code>-1</code></em>)</p>
</blockquote>
<p>Compute accuracy with <code>targ</code> when <code>pred</code> is bs * n_classes</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}
#todo
fold=0
sample_rate=32000
aug_ps=0.25
tile_width=256
bs=64
seed_everything()
cbs = []
path = Path('/kaggle/kaggle_rainforest_audio/data')

rename_cols = RenameColumns(id='recording_id', label='species_id', tmin='t_min', 
                            tmax='t_max',fmin='f_min', fmax='f_max')
df = Pipeline([load_dataframe, rename_cols, group_labels])(path/'train_tp.csv')
train_df, valid_df = kfold_dataframes(df, fold)

model = EmbResNeSt50().cuda()
st = torch.load('/kaggle/kaggle_rainforest_audio/models/model_n0_fold0.pth')['model']
del st['layers.14.weight'], st['layers.14.bias']

tfms = partial(apply_augmentations, augs_pipeline=audio_augment(sample_rate, p=aug_ps))
#tfms = None

train_data = Datasets(items=train_df, tfms=partial(create_dataset_item, path=path,
                                           sample_rate=sample_rate, tile_width=tile_width))
valid_data = Datasets(items=valid_df, tfms=partial(create_dataset_item, path=path,
                                           sample_rate=sample_rate, tile_width=tile_width))
fix_dl_train   = DataLoader(train_data, bs=bs, do_batch=reorganize_batch, num_workers=8,
                      after_batch=MelSpectrogram(sample_rate))
train_dl = EpisodeDataLoader(fix_dl_train, n_episodes=100, dataset=train_data, model=model, bs=bs, do_batch=reorganize_batch, shuffle=True, num_workers=8,
                      after_item=tfms, after_batch=MelSpectrogram(sample_rate))
fix_dl_valid = DataLoader(valid_data, bs=bs, do_batch=reorganize_batch, num_workers=8,
                          after_batch=MelSpectrogram(sample_rate))
valid_dl = EpisodeDataLoader(fix_dl_valid, n_episodes=1, dataset=valid_data, model=model, bs=bs, do_batch=reorganize_batch, num_workers=8,
                          after_batch=MelSpectrogram(sample_rate))

dls = DataLoaders(train_dl, valid_dl, fix_dl_train, fix_dl_valid)
dls.device = torch.device("cuda:0")        

#xb, yb = dls.one_batch()
#show_augmentations(train_data, train_dl, sample_rate=sample_rate)

loss_func = 'soft_triplet_loss'
if loss_func == 'soft_triplet_loss':
    loss = SoftTripletLoss(4)

print('Loss function: ', loss_func)
metric = partial(accuracy, dls=dls, model=model)
learn = Learner(dls, model, loss_func=loss, metrics=metric, cbs=cbs)
learn.to_fp16(clip=0.5);
</div>
 

